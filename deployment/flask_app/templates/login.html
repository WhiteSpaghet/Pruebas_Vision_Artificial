{% extends "base.html" %}
{% block title %}Iniciar sesión - VISION_ARTIFICIAL{% endblock %}

{% block content %}
<div style="max-width:520px; margin: 10px auto;">
  <div class="card" style="padding:18px;">
    <h2>Iniciar sesión</h2>

    <form id="login-form" autocomplete="on">
      <label for="email">Email</label><br>
      <input id="email" name="email" type="email" required style="width:100%; padding:8px; margin-top:6px;"><br><br>

      <label for="password">Contraseña</label><br>
      <input id="password" name="password" type="password" required style="width:100%; padding:8px; margin-top:6px;"><br><br>

      <div style="display:flex; gap:8px;">
        <button type="submit" class="btn">Entrar</button>
        <button id="btn-register" type="button" class="btn" style="background:#888">Crear cuenta</button>
      </div>
    </form>

    <div id="login-msg" style="margin-top:12px;"></div>

    <div style="margin-top:12px;">
      ¿Olvidaste tu contraseña? <a href="{{ url_for('reset_password') if 'reset_password' in (app.view_functions|list) else url_for('register') }}">Recuperarla</a>.
    </div>
  </div>
</div>

<script>
(async function initFirebaseLogin(){
  // 1) cargar la config (archivo que colocaste en static/firebase_config.json)
  try {
    const cfgRes = await fetch("{{ url_for('static', filename='firebase_config.json') }}");
    if (!cfgRes.ok) {
      console.warn("No se encontró firebase_config.json en static. Sigue con login local.");
      return;
    }
    const cfg = await cfgRes.json();

    // 2) cargar compat SDKs (más simple para snippets)
    const base = "https://www.gstatic.com/firebasejs/9.22.2";
    await Promise.all([
      new Promise(r=>{ const s=document.createElement('script'); s.src = base + "/firebase-app-compat.js"; s.onload=r; document.head.appendChild(s); }),
      new Promise(r=>{ const s=document.createElement('script'); s.src = base + "/firebase-auth-compat.js"; s.onload=r; document.head.appendChild(s); })
    ]);

    // 3) inicializar firebase client
    if (!window.firebase) {
      console.error("Firebase SDK no disponible.");
      return;
    }
    window.firebase.initializeApp(cfg);
    const auth = window.firebase.auth();

    // Helper: enviar idToken al backend y crear session
    async function sendIdTokenToServer(idToken) {
      const res = await fetch("{{ url_for('api_login_firebase') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ idToken })
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(t || "error en /api/login_firebase");
      }
      return res.json();
    }

    // Form handlers
    const loginForm = document.getElementById('login-form');
    const msg = document.getElementById('login-msg');
    const registerBtn = document.getElementById('btn-register');

    loginForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      msg.innerText = "Procesando...";
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      try {
        const cred = await auth.signInWithEmailAndPassword(email, password);
        const idToken = await cred.user.getIdToken(true);
        await sendIdTokenToServer(idToken);
        // redirigir al dashboard
        window.location.href = "{{ url_for('dashboard') }}";
      } catch (err) {
        console.error(err);
        msg.innerHTML = `<div class="flash flash-error">${err.message || err}</div>`;
      }
    });

    // Registro rápido (email/password)
    registerBtn.addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (!email || !password) { alert("Rellena email y contraseña para crear cuenta"); return; }
      msg.innerText = "Creando cuenta...";
      try {
        const cred = await auth.createUserWithEmailAndPassword(email, password);
        // opcional: añadir displayName
        await cred.user.updateProfile({ displayName: email.split('@')[0] });
        const idToken = await cred.user.getIdToken(true);
        await sendIdTokenToServer(idToken);
        window.location.href = "{{ url_for('dashboard') }}";
      } catch (err) {
        console.error(err);
        msg.innerHTML = `<div class="flash flash-error">${err.message || err}</div>`;
      }
    });

  } catch (e) {
    console.warn("Init firebase failed", e);
  }
})();
</script>
{% endblock %}
